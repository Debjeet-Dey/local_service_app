{% extends 'base.html' %}

{% block head %}
<title>Create Account</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
{% endblock head %}

{% block body %}
<div class="container d-flex justify-content-center align-items-center min-vh-100 py-5">
    
    <div class="card shadow p-4" style="width: 100%; max-width: 600px;">
        
        <div class="text-center mb-4">
            <h2 class="fw-bold text-primary">User Signup</h2>
            <p class="text-muted">Create your account to get started</p>
        </div>

        {% with messages = get_flashed_messages() %}
            {% if messages %}
                {% for message in messages %}
                <div class="alert alert-warning alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <form method="POST" action="{{ url_for('register') }}">
            
            <div class="row g-3 mb-3">
                <div class="col-md-6">
                    <label for="FullName1" class="form-label fw-bold">Full Name</label>
                    <input name="fullname" type="text" class="form-control" id="FullName1" placeholder="John Doe" required>
                </div>
                <div class="col-md-6">
                    <label for="EmailID1" class="form-label fw-bold">Email Address</label>
                    <input name="email" type="email" class="form-control" id="EmailID1" placeholder="name@example.com" required>
                </div>
            </div>

            <div class="row g-3 mb-3">
                <div class="col-md-6">
                    <label for="CreatePassword1" class="form-label fw-bold">Password</label>
                    <input name="password" type="password" class="form-control" id="CreatePassword1" required>
                </div>
                <div class="col-md-6">
                    <label for="roleSelect" class="form-label fw-bold">I want to...</label>
                    <select name="role" class="form-select" id="roleSelect" aria-label="role" required>
                        <option value="" selected disabled>Select Role</option>
                        <option value="consumer">Hire Someone (Consumer)</option>
                        <option value="provider">Offer Services (Provider)</option>
                    </select>
                </div>
            </div>

            <div class="mb-3" id="serviceTypeContainer" style="display: none;">
                <label for="serviceSelect" class="form-label fw-bold">Service Type</label>
                <select name="service_type" class="form-select" id="serviceSelect" aria-label="service type">
                    <option value="" selected disabled>Choose Service Type</option>
                    <option value="Electrician">Electrician</option>
                    <option value="Plumber">Plumber</option>
                    <option value="Carpenter">Carpenter</option>
                    <option value="Teacher">Teacher</option>
                    <option value="Mason">Mason</option>
                    <option value="Technician">Technician</option>
                    <option value="Welder">Welder</option>
                    <option value="Maid">Maid</option>
                    <option value="Labour">Labour</option>
                    <option value="Barber">Barber</option>
                    <option value="General Physician">General Physician</option>
                    <option value="Consultant">Consultant</option>
                    <option value="Priest">Priest</option>
                    <option value="House Cleaning">House Cleaning</option>
                    <option value="Chef">Chef</option>
                </select>
                <div class="form-text">Required for providers only.</div>
            </div>

            <div class="mb-3">
                <label class="form-label fw-bold">Set Your Location</label>
                <div id="map" style="height: 250px; border-radius: 8px; border: 1px solid #ced4da;"></div>
                <small class="text-muted text-center d-block mt-1">
                    Click the map to pin your location
                </small>
                <input type="hidden" name="latitude" id="latitude" required>
                <input type="hidden" name="longitude" id="longitude" required>
            </div>

            <div class="d-grid gap-2 mb-3">
                <button type="submit" class="btn btn-primary btn-lg">Register</button>
            </div>

            <div class="text-center">
                <p class="mb-0">Already have an account? <a href="{{ url_for('login')}}" class="text-decoration-none">Login here</a></p>
            </div>
        </form>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // --- ROLE SELECTION LOGIC ---
    const roleSelect = document.getElementById('roleSelect');
    const serviceSelect = document.getElementById('serviceSelect');
    const serviceContainer = document.getElementById('serviceTypeContainer');

    function toggleServiceField() {
        if (roleSelect.value === 'provider') {
            // Show the container
            serviceContainer.style.display = 'block';
            // Enable and Make Required
            serviceSelect.disabled = false;
            serviceSelect.required = true;
        } else {
            // Hide the container (Cleaner UI)
            serviceContainer.style.display = 'none';
            // Disable and Remove Required
            serviceSelect.disabled = true;
            serviceSelect.required = false;
            serviceSelect.value = ""; 
        }
    }

    // Event Listener
    roleSelect.addEventListener('change', toggleServiceField);

    // Run on load (in case of page refresh/cache)
    toggleServiceField();


    // --- MAP LOGIC ---
    // Default center (India)
    var map = L.map('map').setView([22.9734, 78.6569], 5);

    // Tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    var marker;

    // Click to select location
    map.on('click', function (e) {
        var lat = e.latlng.lat;
        var lng = e.latlng.lng;

        if (marker) {
            map.removeLayer(marker);
        }

        marker = L.marker([lat, lng]).addTo(map);

        // Store values in hidden inputs
        document.getElementById('latitude').value = lat;
        document.getElementById('longitude').value = lng;
    });

    // Auto-detect user location
    map.locate({ setView: true, maxZoom: 16 });

    map.on('locationfound', function (e) {
        if (!marker) {
            marker = L.marker(e.latlng).addTo(map);
            document.getElementById('latitude').value = e.latlng.lat;
            document.getElementById('longitude').value = e.latlng.lng;
        }
    });
</script>

{% endblock body %}